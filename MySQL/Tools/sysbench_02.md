# sysbench 在美团点评中的应用

[原文](https://tech.meituan.com/2017/07/14/sysbench-meituan.html)

如何快速入门数据库？以我个人经验来看，数据库功能和性能测试是一条不错的捷径。当然从公司层面，数据库测试还有更多实用的功能。这方面，美团点评使用的是知名工具 [sysbench](https://github.com/akopytov/sysbench)，主要是用来解决以下几个问题：

* 统一测试方法，以便测试结果的可重复和可对比。

* 结合美团点评的业务特点和硬件特性，得到最优的参数配置。

* 扩展 sysbench 的测试能力，比如增加对 JSON 测试的支持。

数据库测试虽然入门简单，但是却能在测试中获得对数据库、操作系统等的感性认识，为日后深入的研究数据库和性能调优打下很好的基础。如果你不满足于仅仅使用测试工具，还想开发自己的测试工具，那么在本文的最后，还会从源码层面解读 sysbench 的高性能秘密。

## 测试可重复性

如果只是把测试工具运行起来，获得一个输出结果，那么测试就变成一个没有任何技术含量，也没有实际意义的事情。一个经得起推敲的测试，首先 **`要保证测试结果的可重复性。测试结果的可重复性可能与系统的硬件、操作系统的版本、I/O调度算法、CPU调度算法、数据库版本、数据库的配置、测试工具、测试时间等息息相关`**。美团点评集团 DBA 有两位数以上，如果没有一个统一的测试平台，那么每个 DBA 的测试结果将难以比较，整个团队也无法有效协作。为了解决这个问题，我们做了几点的强制统一：测试工具及其参数的统一、MySQL 配置的统一。

### 为何选用 sysbench

当前可采用的测试工具有 sysbench、TPCC-MySQL 以及公司或者个人开发的压测工具。从功能上来讲，无论采用哪种方式都可以满足要求。美团点评采用 sysbench 有如下几点考虑：

1. sysbench 作为业界流行的测试工具，绝大多数 DBA 都熟悉它。

2. MySQL 几大主流厂商 Oracle、Percona 等在发布性能数据时，都采用 sysbench 作为测试工具。使用相同的测试工具，更便于复现测试结果。

3. sysbench 目前已支持 MySQL 8.0 的测试，因此从长远来看，该工具将会持续活跃。美团点评可以充分利用开源社区资源，降低测试工具的维护成本。

4. sysbench 内嵌了 Lua 脚本。在不需要修改核心的 C 语言代码的情况下，通过增添或者修改 Lua 脚本，即可扩展新的测试场景，大大提高了 DBA 人员对 sysbench 的掌控能力。

### 测试参数统一

sysbench 提供了丰富的测试选项，包括测试表数量、单表数据量、测试预热时间等。我们根据美团点评的业务特征和使用 sysbench 的经验，为了避免新同学走不必要的弯路和降低测试的时间，将部分测试参数统一。另外在测试中，对 MySQL 核心参数做了强制统一。比如 **`sync_binlog=1，innodb_flush_log_at_trx_commit=2，innodb_io_capacity=2000`** 等。这里不一一赘述。

这里简要介绍 sysbench 测试过程中涉及到的几个重要参数：

| 参数名 | 参数值 | 解释 |
| :- | :- | :- |
| tables | 16 | 测试中使用的表分别为 sbtest1 … sbtest16 |
| table_size | 25,000,000 | 每个表的数据量 |
| threads | 16 | 测试线程数 | 
| time | 3600 | 测试时间，单位为秒 |
| warmup_time | 600 | 预热时间，预防冷数据对测试结果影响 |
| rate | 0 | 如果该值不为 0，则整个测试变成生产者和消费者模式。如果该值较大，超出 MySQL 的处理能力，则会造成请求积压，响应时间延长，无法反应真实的 OLTP 业务特性 |
| histogram | on | 输出测试过程中系统响应时间的分布 |
| percentile | 99 | 输出 99 线的响应时间 |

### sysbench 助力参数优化

相对于业务更新速度，数据库的变化较为缓慢，然而影响 MySQL 数据库性能的因素却不断呈现出来。硬件方面，比如 SATA、SSD、PCIe 的出现，让数据库的 IO 能力相对于传统的机械硬盘有几百甚至上千倍的提升；CPU 多核技术的发展，让单台服务器拥有上百个核；单 GB 内存的价格越来越低，服务器配置的内存也越来越大。软件方面，MySQL 5.7 的出现，增强了多核处理能力，提高了从库的复制速度等。

如何将新硬件和新版本的性能发挥到极致，是每个 DBA 都会遇到的问题。美团点评 DBA 团队在前期理论调研后，会设计符合公司业务特征的场景进行严格的性能测试，确定最终的参数配置方案。下面以确定 MySQL 5.7 中多线程复制的 **`slave_parallel_workers`** 参数为例，来了解如何使用 sysbench 来优化参数配置。

为了测试从库的复制速度，我们使用 sysbench 的 **`oltp_write_only.lua`**（包括增、删、改）在主库制造负载（**TPS:33,336**），观察从库的TPS，如下图所示。

![]( "slave_parallel_workers")

从上图看出，工作线程在 8 时，从库的 TPS 达到最大。到这里为止，对于数据库新人来说，我们可以很自信的宣称自己学会了通过测试进行数据库调优。但是我们不能只满足于此，应该做更深入的探究。比如，多线程复制的原理是怎样的？如何进一步提升从库的 TPS ？建议有兴趣的读者可以继续调研 **`binlog_group_commit_sync_delay`** 和 **`binlog_group_commit_sync_no_delay_count`** 参数。

## sysbench 可扩展性

### 测试场景可扩展

sysbench 不仅具有丰富的功能，还具有优良的设计与实现。为了把测试场景完全交给客户定制，所有的测试用例，均使用 Lua 编写；如果需要支持新的数据库，只要实现 sysbench 提供的 10 来个接口即可；而其他通用功能，均由 sysbench 提供。架构图如下：

![]( "架构图")

使用过 sysbench 或者其他同类型测试工具的都知道，**`数据库测试分为三个阶段，包括prepare 阶段、warmup 阶段、运行阶段`**。这三个过程的实现完全使用Lua来控制，因此很容易定制。sysbench提供的默认测试用例有只读测试、只写测试、读写混合等。这些测试用例也是用Lua实现的，通过修改这些测试用例，测试人员可以很快的掌握编写自己测试用例的技巧。

比如，日前在评估MySQL 5.7 JSON替代MongoDB的可行性。与业务人员交流过程中发现，业务中并没有使用MongoDB的一些复杂特性，比如内嵌JS代码、map/reduce等特性，但是其TPS较高，较为关注MySQL 5.7+JSON与MongoDB的性能比较。因此需要一款可以测试MySQL JSON性能的测试工具。在前一节的分析中，我们只需更改sysbench中几个Lua文件即可拥有这样的测试工具。

